<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<script src="../js/jquery.js"></script>
	<script src="../js/session.js"></script>
	<script src="../js/tools.js"></script>
	<script src="js/qunit.js"></script>
	<script src="js/qunit.mock.js"></script>
	<link rel="stylesheet" href="css/qunit.css" type="text/css" media="screen" />

	<script>
	var server = "http://localhost";
	$(document).ready(function(){
		var yahoos = new session();
		var doNotInclude;
		var test1 = function() {
			test("login with porting session", 1, function() {
				stop();
				var current = new session();
				chrome.windows.getCurrent(function(currentWin) {
					doNotInclude = currentWin.id;
					current.updateAll(null, doNotInclude);
					chrome.extension.sendRequest({ type: "login", username: "user1",
							password: "pass1", portSession: true, doNotInclude: doNotInclude },
						function() {
							var s = new session();
							s.updateAll(function() {
								console.log("test1");
								deepEqual(s.info, current.info, "logging in with porting" +
									" session leaves all the same");
								start();
								test2();
							}, doNotInclude);
						}
					);
				});
			});
		};
		var test2 = function() {
			test("logout returns previous session", 1, function(){
				stop();
				var current = new session();
				current.updateAll(function() {
					var newWin = getYahooWin();
					var afterLogout = function() {
						var s = new session();
						setTimeout(function() { 
		//this is cheeky but it problematic to make afterLogout exactly after logout is complete
							s.updateAll(function(){
								console.log("test2");
								deepEqual(s.info, current.info, "session before login is "
								 	+ "same as  after logout")
								start();
								test3();
							}, doNotInclude);
						}, 1000);
					};
					var afterWinsSet = function() {
						setTimeout(function() { //timeout so cookies will be set
							yahoos.updateAll(function() {
								chrome.extension.sendRequest({ type: "logout",
									doNotInclude: doNotInclude, sync: true }, afterLogout);
							}, doNotInclude);
						}, 1000);
					};
					setWindows([newWin], afterWinsSet, true);
				}, doNotInclude);
			});
		};
		var test3 = function() {
			test("login opens recent windows", 3, function() {
				stop();
				chrome.extension.sendRequest({ type: "login", username: "user1",
						password: "pass1", doNotInclude: doNotInclude },
					function() {
						var s = new session();
						setTimeout(function() { //timeout so cookies will be set
							s.updateAll(function() {
								console.log("test3");
								equal(s.info.windows.length, yahoos.info.windows.length,
									"opened same number of windows that were open on logout");
								equal(s.info.windows[0].tabs[0].url, yahoos.info.windows[0].tabs[0].url,
									"opened same url as on logout");
								deepEqual(s.info.cookies, yahoos.info.cookies, "cookies are the same");
								start();
								chrome.extension.sendRequest({ type: "logout", doNotInclude: doNotInclude,
									sync: true }, function() { session1.applyCookies(); });
							}, doNotInclude);
						}, 1000);
					}
				);
			});
		}
		var session1 = new session();
		session1.updateCookies(deleteCookies(test1));
	});

	function getYahooWin() {
		var winToOpen = new Object();
		winToOpen.left = 10;
		winToOpen.top = 10;
		winToOpen.type = "normal";
		winToOpen.height = 400;
		winToOpen.incognito = false;
		winToOpen.width = 400;
		var tab = new Object();
		tab.url = "http://localhost";
		tab.selected = false;
		winToOpen.tabs = [tab, tab, tab];
		return winToOpen;
	}
  </script>
</head>
<body>
	<h1 id="qunit-header">Overall Tests</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
	<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>