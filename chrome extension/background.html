<script src="jQuery.js"></script>
<script src="tools.js"></script>
<script src="session.js"></script>
<script type="text/javascript">

// var server = "http://cloudbrowsing.appspot.com";
var server = "http://localhost";

var current = new session();

chrome.extension.onRequest.addListener(
function(request, sender, sendResponse) {
	console.log("received message " + request.type);
	switch (request.type) {
		case "send": 
			sendData();
			break;
		case "receive":	
			receiveData();
			break;
		case "deleteLocal":
			deleteCookies();
			break;
		case "deleteFromServer":
			deleteFromServer();
			break;
		case "login":				
			sendResponse({ success: login(request.username, request.password) });
			return; // return since the response is sent here
		case "logout":
			sendResponse({ success: logout() });
			return; // return since the response is sent here
		case "isLoggedIn":
		    sendResponse({ result: isLoggedIn(), 
						   username: localStorage.getItem("username") });
			return; // return since the response is sent here
		default:
			console.log("ERROR: got an ill typed message from 'popup'");
	}
    sendResponse({});
});

function login(username, password) {
	if (username == "" || password == "" ||
		username == undefined || password == undefined) { //TODO: change undefined
		console.log("username or password not valid");
		return false;
	}
	localStorage.setItem("username", username);
	localStorage.setItem("password", password);
	console.log("user logged in");

	var s = new session();
	s.updateAll(function() {
		localStorage.setItem("oldSession", s.serialize());
		deleteCookies();
		current = new session()
		receiveData();
	});

	return true;
}

function logout() {
	var old = new session();
	old.deSerialize(localStorage.getItem("oldSession"));
	sendData(function() {
		deleteCookies(function() {
			old.applyAll();
			current = old;
			localStorage.setItem("username", "");
			localStorage.setItem("password", "");
		})
	});
	console.log("user logged out");

	return true;
}

function errorFunction(request) {
	//TODO: maybe add more functionality to this
	console.log(request.status + ": " + request.statusText);
}

function sendData(callback) {
	console.log("in sendData");
	if (!isLoggedIn()) {
		console.log("user not logged in send data cancelled");
		if (callback)
			callback();
		return;
	}
	current.updateAll(function() {
		$.ajax({
			type: "POST",
			//since the server receives the data
			url: server + "/ReceiveData",
			data: {	
				user: localStorage.getItem("username"),
				pass: localStorage.getItem("password"),
				dataFromClient: current.serialize()
			},
			success: function(data) {
				console.log("data from server: " + data);
			},
			complete: function() {
				if (callback)
					callback();
			},
			error: errorFunction
		});
	});
}

function receiveData() {
	console.log("in receiveData");
	if (!isLoggedIn()) {
		console.log("user not logged in receive data cancelled");
		return;
	}
	$.ajax({
		//since the server sends the data
		url: server + "/SendData",
		data: {
			user: localStorage.getItem("username"),
			pass: localStorage.getItem("password"),
		},
		success: function(data) {
			if (data == "") {
				console.log("no data was received");
				return; // no cookies to set
			}
			// setCookies(JSON.parse(data).cookies);
			current.deSerialize(data);
			current.applyAll();
		},
		error: errorFunction
	});
}

function deleteFromServer() {
	$.ajax({
		url: server + "/DeleteCookiesFromServer",
		success: function(data) { 
			console.log(data); 	
		},
		error: errorFunction
	});
}

</script>