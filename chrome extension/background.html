<script src="jQuery.js"></script>
<script type="text/javascript">
	chrome.extension.onRequest.addListener(
	function(request, sender, sendResponse) {
	    console.log("received message " + request.type);
		switch (request.type) {
			case "send": 
				sendData();
				break;
			case "receive":	
				receiveData();
				break;
			case "deleteLocal":
				deleteCookies();
				break;
			case "deleteFromServer":
				deleteFromServer();
				break;
			case "login":				
				sendResponse({ success: login(request.username, request.password) });
				return; // return since the response is sent here
			case "logout":
				sendResponse({ success: logout() });
				return; // return since the response is sent here
			case "isLoggedIn":
			    sendResponse({ result: isLoggedIn(), 
							   username: localStorage.getItem("username") });
				return; // return since the response is sent here
			default:
				console.log("ERROR: got an ill typed message from 'popup'");
		}
	    sendResponse({});
	});

	function isLoggedIn(){
		return localStorage.getItem("username") != null &&
			   localStorage.getItem("password") != null &&
			   localStorage.getItem("username") != "" &&
			   localStorage.getItem("password") != "";
	}

	function login(username, password) {
		if (username == "" || password == "" ||
			username == undefined || password == undefined) {
			console.log("username or password not valid");
			return false;
		}
		localStorage.setItem("username", username);
		localStorage.setItem("password", password);		
		console.log("user logged in");
		return true;
	}
	
	function logout() {
		localStorage.setItem("username", "");
		localStorage.setItem("password", "");
		console.log("user logged out");
		return true;
	}
	
	function errorFunction(request) {
		//TODO: maybe add more functionality to this
		console.log(request.status + ": " + request.statusText);
	}

	function sendData() {
		console.log("in sendData");
		if (!isLoggedIn()) {
			console.log("user not logged in send data cancelled");
			return;
		}
		chrome.cookies.getAll({}, function(cookies) { 
			console.log("cookies length: " + cookies.length);
			$.ajax({
				type: "POST",
				//since the server receives the data
				url: "http://localhost/ReceiveData",
				data: {	
					user: localStorage.getItem("username"),
					pass: localStorage.getItem("password"),
					cookiesFromClient: JSON.stringify(cookies)
				},
				success: function(data) {
					console.log("data from server: " + data);
				},
				error: errorFunction
			});
		});
	}
	
	function receiveData() {
		console.log("in receiveData");
		if (!isLoggedIn()) {
			console.log("user not logged in receive data cancelled");
			return;
		}
		$.ajax({
			//since the server sends the data
			url: "http://localhost/SendData",
			data: {
				user: localStorage.getItem("username"),
				pass: localStorage.getItem("password"),
			},
			success: function(data) {
				if (data == "") {
					console.log("no cookies were received");
					return; // no cookies to set
				}
				var cookies = JSON.parse(data);
				console.log("received " + cookies.length + " cookies");
				for (var i=0; i<cookies.length; i++) {
					//maybe move this mambo jambo to another function
					var newCookie = new Object;
					var current = cookies[i];
					newCookie.url = ((current.secure) ? 
						"https://" : "http://") + current.domain;
					newCookie.name = current.name;
					newCookie.value = current.value;
					if (!current.hostOnly)
						newCookie.domain = current.domain;
					newCookie.path = current.path;
					newCookie.secure = current.secure;
					newCookie.httpOnly = current.httpOnly;
					if (!current.session)
						newCookie.expirationDate = current.expirationData;
					newCookie.storeId = current.storeId;
					chrome.cookies.set(newCookie);
				}
				console.log("cookies were set successfully");
			},
			error: errorFunction
		});
	}
	
	function deleteFromServer() {
		$.ajax({
			url: "http://localhost/DeleteCookiesFromServer",
			success: function(data) { 
				console.log(data); 	
			},
			error: errorFunction
		});
	}
	
	function deleteCookies() {
		console.log("deleting cookies...");
		chrome.cookies.getAll({}, function(cookies) {
			for(var i=0; i<cookies.length; i++) {
				var current = cookies[i];
				var cookies2Remove = new Object;
				cookies2Remove.url = ((current.secure) ? 
					"https://" : "http://") + current.domain;	
				cookies2Remove.name = current.name;
				cookies2Remove.storeId = current.storeId;
				chrome.cookies.remove(cookies2Remove);
			}
			console.log(cookies.length + " cookies have been deleted");
		});
	}
</script>